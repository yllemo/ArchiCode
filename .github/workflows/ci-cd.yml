name: CI/CD Pipeline

on:
  push:
    branches: [ main, develop ]
  pull_request:
    branches: [ main ]
  release:
    types: [ published ]

jobs:
  lint:
    name: Lint Code
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '18'
          cache: false

      - name: Install dependencies
        run: npm install --no-package-lock

      - name: Run ESLint
        run: npm run lint

      - name: Check formatting
        run: npx prettier --check "*.js" "demo/*.html" "*.css" "*.md"

  test:
    name: Run Tests
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '18'
          cache: false

      - name: Install dependencies
        run: npm install --no-package-lock

      - name: Run tests
        run: npm test

  validate-examples:
    name: Validate Examples
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '18'
          cache: false

      - name: Test example parsing
        run: |
          node -e "
          const fs = require('fs');
          const ArchiCode = require('./archicode.js');
          
          // Test each example file
          const examples = fs.readdirSync('examples').filter(f => f.endsWith('.archimate'));
          
          for (const example of examples) {
            const code = fs.readFileSync(\`examples/\${example}\`, 'utf8');
            try {
              console.log(\`Testing \${example}...\`);
              const result = ArchiCode.parse ? ArchiCode.parse(code) : 'OK';
              console.log(\`✓ \${example} parsed successfully\`);
            } catch (error) {
              console.error(\`✗ \${example} failed: \${error.message}\`);
              process.exit(1);
            }
          }
          console.log('All examples validated successfully!');
          "

  deploy-demo:
    name: Deploy Demo to GitHub Pages
    runs-on: ubuntu-latest
    needs: [lint, test, validate-examples]
    if: github.ref == 'refs/heads/main'
    
    permissions:
      contents: read
      pages: write
      id-token: write
    
    environment:
      name: github-pages
      url: ${{ steps.deployment.outputs.page_url }}
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Pages
        uses: actions/configure-pages@v4

      - name: Create deployment directory
        run: |
          mkdir -p _site
          cp -r demo/* _site/
          cp archicode.js _site/
          cp archicode.css _site/
          cp -r examples _site/
          
          # Update paths in demo HTML to work with GitHub Pages
          sed -i 's|../archicode.js|./archicode.js|g' _site/index.html
          sed -i 's|../archicode.css|./archicode.css|g' _site/index.html

      - name: Upload artifact
        uses: actions/upload-pages-artifact@v3
        with:
          path: '_site'

      - name: Deploy to GitHub Pages
        id: deployment
        uses: actions/deploy-pages@v4

  publish-npm:
    name: Publish to NPM
    runs-on: ubuntu-latest
    needs: [lint, test, validate-examples]
    if: github.event_name == 'release'
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '18'
          registry-url: 'https://registry.npmjs.org'
          cache: false

      - name: Publish to NPM
        run: npm install --no-package-lock && npm publish --access public
        env:
          NODE_AUTH_TOKEN: ${{ secrets.NPM_TOKEN }}